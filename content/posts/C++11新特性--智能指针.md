---
date: 2025-04-27T17:10:57+08:00
title: C++11æ–°ç‰¹æ€§--æ™ºèƒ½æŒ‡é’ˆ
description: C++11æ–°ç‰¹æ€§--æ™ºèƒ½æŒ‡é’ˆ
featured_image: /images/book.png
images:
  - /images/book.png
tags:
  - tutorial
  - cpp11
categories: Tutorials
---
## 1. ä¸ºä»€ä¹ˆéœ€è¦æ™ºèƒ½æŒ‡é’ˆï¼Ÿ

åœ¨ä¼ ç»Ÿ C++ é‡Œï¼ŒåŠ¨æ€åˆ†é…å†…å­˜éœ€è¦æ‰‹åŠ¨ `new` å’Œ `delete`ã€‚æ¯”å¦‚ï¼š

```cpp
int* p = new int(10);
// ä½¿ç”¨ p
delete p; // å¿…é¡»è®°å¾— delete
```

é—®é¢˜ï¼š

- å¿˜è®° `delete` â†’ **å†…å­˜æ³„æ¼**ã€‚
    
- é‡å¤ `delete` â†’ **ç¨‹åºå´©æºƒ**ã€‚
    
- æå‰ `delete` â†’ **æ‚¬ç©ºæŒ‡é’ˆ**ï¼ˆæŒ‡é’ˆè¿˜åœ¨ï¼Œä½†æŒ‡å‘çš„å†…å­˜å·²ç»æ— æ•ˆï¼‰ã€‚
    

**æ™ºèƒ½æŒ‡é’ˆå°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›ç—›ç‚¹çš„ã€‚**

---

## 2. C++11 æä¾›äº†å“ªäº›æ™ºèƒ½æŒ‡é’ˆï¼Ÿ

|æ™ºèƒ½æŒ‡é’ˆ|è¯´æ˜|
|:--|:--|
|`std::unique_ptr`|ç‹¬å å¼æ™ºèƒ½æŒ‡é’ˆï¼Œ**ä¸€ä¸ªå¯¹è±¡åªèƒ½æœ‰ä¸€ä¸ª unique_ptr æ‹¥æœ‰**ã€‚ä¸èƒ½å¤åˆ¶ï¼Œåªèƒ½ç§»åŠ¨ã€‚|
|`std::shared_ptr`|å…±äº«å¼æ™ºèƒ½æŒ‡é’ˆï¼Œ**å¤šä¸ª shared_ptr å¯ä»¥å…±åŒæ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡**ã€‚å†…éƒ¨æœ‰å¼•ç”¨è®¡æ•°ã€‚|
|`std::weak_ptr`|å¼±å¼•ç”¨æ™ºèƒ½æŒ‡é’ˆï¼Œ**ä¸æ‹¥æœ‰å¯¹è±¡**ï¼Œåªæ˜¯è§‚å¯Ÿã€‚é…åˆ shared_ptr ä½¿ç”¨ï¼Œé˜²æ­¢å¾ªç¯å¼•ç”¨ã€‚|

---

## 3. å„ç§æ™ºèƒ½æŒ‡é’ˆçš„è¯¦ç»†è®²è§£

### 3.1 `std::unique_ptr`

**ç‰¹ç‚¹**ï¼š

- èµ„æºç‹¬å ï¼Œä¸èƒ½å¤åˆ¶ï¼Œåªèƒ½ç§»åŠ¨ã€‚
    
- ææ„æ—¶è‡ªåŠ¨ `delete` ç®¡ç†çš„å¯¹è±¡ã€‚
    

**ç¤ºä¾‹**ï¼š

```cpp
#include <memory>
#include <iostream>

int main() {
    std::unique_ptr<int> uptr(new int(42));
    std::cout << *uptr << std::endl;

    // std::unique_ptr<int> uptr2 = uptr; // é”™è¯¯ï¼Œä¸èƒ½å¤åˆ¶
    std::unique_ptr<int> uptr2 = std::move(uptr); // å¯ä»¥ç§»åŠ¨

    if (!uptr) {
        std::cout << "upträ¸ºç©ºäº†" << std::endl;
    }
}
```

**æ³¨æ„**ï¼š

- `std::move` è½¬ç§»æ‰€æœ‰æƒã€‚
    
- æ¨èç”¨ `std::make_unique`ï¼ˆC++14 åŠ çš„ï¼‰åˆ›å»ºï¼š
    

```cpp
auto uptr = std::make_unique<int>(42);
```

### 3.2 `std::shared_ptr`

**ç‰¹ç‚¹**ï¼š

- å¤šä¸ª `shared_ptr` å¯ä»¥å…±åŒæ‹¥æœ‰ä¸€ä¸ªå¯¹è±¡ã€‚
    
- å†…éƒ¨æœ‰ä¸€ä¸ª**å¼•ç”¨è®¡æ•°å™¨**ï¼Œè®°å½•æœ‰å¤šå°‘ä¸ª `shared_ptr` æŒ‡å‘è¿™ä¸ªå¯¹è±¡ã€‚
    
- æœ€åä¸€ä¸ª `shared_ptr` é”€æ¯æ—¶ï¼Œæ‰é‡Šæ”¾èµ„æºã€‚
    

**ç¤ºä¾‹**ï¼š

```cpp
#include <memory>
#include <iostream>

int main() {
    std::shared_ptr<int> sptr1 = std::make_shared<int>(100);
    std::shared_ptr<int> sptr2 = sptr1; // å¼•ç”¨è®¡æ•° +1

    std::cout << "å¼•ç”¨è®¡æ•°: " << sptr1.use_count() << std::endl; // è¾“å‡º 2
}
```

**æ³¨æ„**ï¼š

- `make_shared`æ•ˆç‡é«˜ï¼Œæ¨èç”¨ã€‚
    
- å¤šä¸ª `shared_ptr` æŒ‡å‘åŒä¸€èµ„æºæ²¡é—®é¢˜ã€‚
    

**å†…éƒ¨åŸç†**ï¼š

- `shared_ptr` å†…éƒ¨æœ‰ä¸€å—å°å†…å­˜ï¼Œè®°å½•**å¼•ç”¨è®¡æ•°**ã€‚
    
- æ¯æ¬¡æ‹·è´ `+1`ï¼Œé”€æ¯ `-1`ï¼Œå½’é›¶å°± `delete`ã€‚
    

### 3.3 `std::weak_ptr`

**ç‰¹ç‚¹**ï¼š

- `weak_ptr` ä¸å½±å“å¼•ç”¨è®¡æ•°ã€‚
    
- ä¸»è¦ç”¨äº**è§‚å¯Ÿ shared_ptr ç®¡ç†çš„å¯¹è±¡**ï¼Œ**é˜²æ­¢å¾ªç¯å¼•ç”¨**ã€‚
    

**ç¤ºä¾‹**ï¼š

```cpp
#include <memory>
#include <iostream>

int main() {
    std::shared_ptr<int> sptr = std::make_shared<int>(200);
    std::weak_ptr<int> wptr = sptr;

    std::cout << "å¼•ç”¨è®¡æ•°: " << sptr.use_count() << std::endl; // 1ï¼Œä¸å˜

    if (auto spt = wptr.lock()) { // å°è¯•æ‹¿åˆ° shared_ptr
        std::cout << *spt << std::endl;
    } else {
        std::cout << "å¯¹è±¡å·²ç»è¢«é‡Šæ”¾" << std::endl;
    }
}
```

**lock() æ–¹æ³•**ï¼š

- `wptr.lock()` è¿”å›ä¸€ä¸ª `shared_ptr`ã€‚
    
- å¦‚æœèµ„æºè¿˜æ´»ç€ï¼Œå°±èƒ½æˆåŠŸï¼›å¦åˆ™è¿”å› `nullptr`ã€‚
    

---

## 4. ä¸‰è€…çš„å…³ç³»å°æ€»ç»“

- `unique_ptr`ï¼šç‹¬å ã€‚ä¸èƒ½æ‹·è´ï¼Œåªèƒ½è½¬ç§»ã€‚
    
- `shared_ptr`ï¼šå…±äº«ã€‚å†…éƒ¨å¼•ç”¨è®¡æ•°ã€‚
    
- `weak_ptr`ï¼šè§‚å¯Ÿï¼Œä¸æ‹¥æœ‰ï¼Œä¸å¢åŠ è®¡æ•°ã€‚
    

---

## 5. ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆçš„æ³¨æ„äº‹é¡¹

âœ… æ¨èç”¨ `make_shared` å’Œ `make_unique` åˆ›å»ºå¯¹è±¡ï¼Œæ•ˆç‡é«˜åˆå®‰å…¨ã€‚

âœ… æ³¨æ„**é¿å…å¾ªç¯å¼•ç”¨**ï¼ˆä¸¤ä¸ªå¯¹è±¡ç›¸äº’æŒæœ‰ `shared_ptr` â†’ èµ„æºé‡Šæ”¾ä¸äº†ï¼Œè¦ç”¨ `weak_ptr` æ‰“ç ´ç¯ï¼‰ã€‚

âœ… ä¸è¦æ‰‹åŠ¨ `delete` æ™ºèƒ½æŒ‡é’ˆç®¡ç†çš„å¯¹è±¡ï¼ˆä¼šå‡ºå¤§é—®é¢˜ï¼‰ã€‚

âœ… å°å¿ƒä»åŸå§‹æŒ‡é’ˆï¼ˆ`T*`ï¼‰è½¬æ¢æˆæ™ºèƒ½æŒ‡é’ˆæ—¶çš„æ‰€æœ‰æƒé—®é¢˜ã€‚

---

## 6. å°ä¾‹å­ï¼šæ™ºèƒ½æŒ‡é’ˆç®¡ç†ç±»å¯¹è±¡

```cpp
#include <memory>
#include <iostream>

class Test {
public:
    Test() { std::cout << "Test constructed" << std::endl; }
    ~Test() { std::cout << "Test destructed" << std::endl; }
};

int main() {
    {
        auto ptr = std::make_shared<Test>();
    } // ç¦»å¼€ä½œç”¨åŸŸï¼Œè‡ªåŠ¨ææ„
    std::cout << "End of main" << std::endl;
}
```

è¾“å‡ºï¼š

```
Test constructed
Test destructed
End of main
```

æ™ºèƒ½æŒ‡é’ˆå¸®ä½ è‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œ**ä¸ç”¨æ‰‹åŠ¨ delete**ï¼Œéå¸¸ä¼˜é›…ï¼

---

## 7. æ™ºèƒ½æŒ‡é’ˆçš„åº•å±‚æœºåˆ¶ï¼ˆç¨å¾®æŠ€æœ¯ä¸€ç‚¹ï¼‰

### 7.1 `shared_ptr` çš„å†…éƒ¨ç»“æ„

å¯ä»¥ç†è§£æˆå®ƒç»´æŠ¤äº†ä¸¤æ ·ä¸œè¥¿ï¼š

- **èµ„æºæŒ‡é’ˆ**ï¼šçœŸæ­£æŒ‡å‘ç®¡ç†å¯¹è±¡çš„æŒ‡é’ˆã€‚
    
- **æ§åˆ¶å—ï¼ˆControl Blockï¼‰**ï¼šä¿å­˜å¼•ç”¨è®¡æ•°ã€å¼±å¼•ç”¨è®¡æ•°ç­‰ä¿¡æ¯ã€‚
    

å¤§æ¦‚ç»“æ„åƒè¿™æ ·ï¼ˆç”»ä¸ªç®€å›¾ç»™ä½ çœ‹ï¼‰ï¼š

```
+----------------+         +-----------------+
| shared_ptr A   |         |  Control Block   |
| -------------  | ----->  | - strong_count=2 |
| - ptr          |         | - weak_count=1   |
+----------------+         +-----------------+
       |
+----------------+
|   Managed Obj  |
+----------------+
```

- `strong_count`ï¼šå¤šå°‘ä¸ª `shared_ptr` æ­£åœ¨ç®¡ç†å¯¹è±¡ã€‚
    
- `weak_count`ï¼šå¤šå°‘ä¸ª `weak_ptr` è§‚å¯Ÿè¿™ä¸ªå¯¹è±¡ã€‚
    

å½“ `strong_count == 0`ï¼š

- èµ„æºå¯¹è±¡é‡Šæ”¾ã€‚
    
- ä½†æ§åˆ¶å—è¿˜ä¿ç•™ï¼ˆå› ä¸ºå¯èƒ½è¿˜æœ‰ `weak_ptr`ï¼‰ã€‚
    

å½“ `strong_count == 0 && weak_count == 0`ï¼š

- æ§åˆ¶å—ä¹Ÿé‡Šæ”¾ã€‚
    

### 7.2 `unique_ptr` çš„å†…éƒ¨ç»“æ„

è¶…çº§ç®€å•ï¼š

- åªæœ‰ä¸€ä¸ªè£¸æŒ‡é’ˆã€‚
    
- ä¹Ÿæ²¡æœ‰æ§åˆ¶å—ï¼Œä¹Ÿæ²¡æœ‰å¼•ç”¨è®¡æ•°ã€‚
    

å°±æ˜¯ä¸€ä¸ª**å•çº¯çš„æ‹¥æœ‰è€…**ï¼Œç”Ÿå‘½å‘¨æœŸæ¸…æ¸…çˆ½çˆ½ã€‚

---

## 8. æ™ºèƒ½æŒ‡é’ˆçš„è‡ªå®šä¹‰åˆ é™¤å™¨

æœ‰æ—¶å€™ï¼Œ**`delete` ä¸æ˜¯ä½ æƒ³è¦çš„é”€æ¯æ–¹å¼**ï¼Œæ¯”å¦‚é‡Šæ”¾æ–‡ä»¶å¥æŸ„ã€é‡Šæ”¾å¥—æ¥å­—ï¼Œå°±å¯ä»¥ç”¨è‡ªå®šä¹‰åˆ é™¤å™¨ã€‚

### 8.1 `unique_ptr` è‡ªå®šä¹‰åˆ é™¤å™¨

```cpp
#include <memory>
#include <iostream>

struct FileCloser {
    void operator()(FILE* fp) const {
        if (fp) {
            fclose(fp);
            std::cout << "File closed" << std::endl;
        }
    }
};

int main() {
    std::unique_ptr<FILE, FileCloser> fp(fopen("test.txt", "w"));
    if (fp) {
        fputs("Hello, World!", fp.get());
    }
}
```

- è¿™é‡Œ `FileCloser` æ˜¯ä¸€ä¸ªä»¿å‡½æ•°ï¼Œä¸“é—¨å¹²**`fclose`**å·¥ä½œã€‚
    
- `unique_ptr` å¯ä»¥å¸¦ä¸€ä¸ªåˆ é™¤å™¨ç±»å‹å‚æ•°ã€‚
    

### 8.2 `shared_ptr` è‡ªå®šä¹‰åˆ é™¤å™¨

```cpp
#include <memory>
#include <iostream>

int main() {
    auto deleter = [](int* p) {
        std::cout << "Deleting int: " << *p << std::endl;
        delete p;
    };

    std::shared_ptr<int> sptr(new int(10), deleter);
}
```

- `shared_ptr` ä¹Ÿæ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨ï¼Œå¸¸ç”¨ lambda è¡¨è¾¾å¼å†™ã€‚
    

---

## 9. å°å¿ƒæ™ºèƒ½æŒ‡é’ˆçš„å‘

### 9.1 ä¸è¦å¤šæ¬¡ç®¡ç†åŒä¸€ä¸ªè£¸æŒ‡é’ˆï¼

**é”™è¯¯ç¤ºä¾‹**ï¼š

```cpp
int* p = new int(5);
std::shared_ptr<int> sp1(p);
std::shared_ptr<int> sp2(p); // âŒ ä¸¤ä¸ªshared_ptréƒ½ä»¥ä¸ºè‡ªå·±è¯¥è´Ÿè´£deleteï¼
```

- ç»“æœï¼šç¨‹åºå´©æºƒï¼ŒåŒé‡é‡Šæ”¾ã€‚
    

âœ… æ­£ç¡®åšæ³•æ˜¯ï¼Œåªäº¤ç»™ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆç®¡ç†ï¼š

```cpp
auto sp1 = std::make_shared<int>(5);
// éœ€è¦å…±äº«ï¼Œç”¨æ‹·è´sp1å³å¯ã€‚
auto sp2 = sp1;
```

---

## 10. æ€»ç»“å¤§å›¾ï¼

æˆ‘ç”»äº†ä¸€å¼ **æ€»ç»“å›¾**ï¼Œæ¥å¸®ä½ å¿«é€Ÿè®°å¿†ï¼š

```
ã€æ™ºèƒ½æŒ‡é’ˆæ€»ç»“ã€‘

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ unique_ptr   â”‚
â”‚ - ç‹¬å èµ„æº    â”‚
â”‚ - ä¸å¯æ‹·è´    â”‚
â”‚ - å¯ç§»åŠ¨      â”‚
â”‚ - è½»é‡å¿«      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“  è½¬ç§»æ‰€æœ‰æƒ (move)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ shared_ptr   â”‚
â”‚ - å…±äº«èµ„æº    â”‚
â”‚ - å¼•ç”¨è®¡æ•°    â”‚
â”‚ - è‡ªåŠ¨é‡Šæ”¾    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†“  è§‚å¯Ÿå¯¹è±¡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ weak_ptr     â”‚
â”‚ - ä¸æ‹¥æœ‰èµ„æº  â”‚
â”‚ - ä¸å¢åŠ è®¡æ•°  â”‚
â”‚ - é˜²æ­¢å¾ªç¯å¼•ç”¨â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. å°æ‰©å±•ï¼šä»€ä¹ˆæ—¶å€™ç”¨å“ªç§æ™ºèƒ½æŒ‡é’ˆï¼Ÿ

|åœºæ™¯|æ¨èæŒ‡é’ˆ|
|:--|:--|
|èµ„æºå½’å±å”¯ä¸€ï¼Œç®€å•çš„å¯¹è±¡ç”Ÿå‘½å‘¨æœŸ|`unique_ptr`|
|èµ„æºéœ€è¦å¤šä¸ªå¯¹è±¡å…±äº«|`shared_ptr`|
|éœ€è¦è§‚å¯Ÿä½†ä¸ç®¡ç†èµ„æºï¼Œé˜²æ­¢ç¯çŠ¶å¼•ç”¨|`weak_ptr`|

**å®é™…å¼€å‘ä¸­**ï¼š

- **èƒ½ç”¨ `unique_ptr` å°±ç”¨ `unique_ptr`**ï¼Œå¼€é”€æœ€å°ã€‚
    
- **åªæœ‰ç¡®å®éœ€è¦å…±äº«æ‰€æœ‰æƒæ—¶**æ‰ç”¨ `shared_ptr`ã€‚
    
- **é¿å…å¾ªç¯å¼•ç”¨æ—¶**é…åˆ `weak_ptr`ã€‚
    

---

---

## ğŸ¯ æ¡ˆä¾‹ä¸€ï¼š`unique_ptr` ç®¡ç†åŠ¨æ€èµ„æº

**åœºæ™¯**ï¼šç®¡ç†å•ä¸ªå¯¹è±¡ï¼Œä¿è¯æ— æ‹·è´ï¼Œè‡ªåŠ¨é‡Šæ”¾ã€‚

```cpp
#include <iostream>
#include <memory>

class Widget {
public:
    Widget() { std::cout << "Widget created\n"; }
    ~Widget() { std::cout << "Widget destroyed\n"; }
    void operation() { std::cout << "Widget operation\n"; }
};

void useWidget() {
    std::unique_ptr<Widget> w = std::make_unique<Widget>();
    w->operation(); // ä½¿ç”¨å¯¹è±¡
} // ç¦»å¼€ä½œç”¨åŸŸï¼Œè‡ªåŠ¨é”€æ¯ Widget

int main() {
    useWidget();
    return 0;
}
```

**è¦ç‚¹**ï¼š

- ä½¿ç”¨ `std::make_unique` åˆ›å»ºå¯¹è±¡ã€‚
    
- ä¸éœ€è¦æ‰‹åŠ¨ `delete`ï¼Œæ›´å®‰å…¨ã€‚
    

---

## ğŸ¯ æ¡ˆä¾‹äºŒï¼š`shared_ptr` å¤šä¸ªå…±äº«è€…å…±åŒç®¡ç†å¯¹è±¡

**åœºæ™¯**ï¼šå¤šä¸ªæ¨¡å—æˆ–ç»„ä»¶éœ€è¦**å…±äº«è®¿é—®åŒä¸€èµ„æº**ã€‚

```cpp
#include <iostream>
#include <memory>

class Data {
public:
    Data(int v) : value(v) { std::cout << "Data created\n"; }
    ~Data() { std::cout << "Data destroyed\n"; }
    void show() const { std::cout << "Value: " << value << "\n"; }
private:
    int value;
};

void processData(std::shared_ptr<Data> p) {
    p->show();
}

int main() {
    std::shared_ptr<Data> data = std::make_shared<Data>(42);
    processData(data);
    processData(data);

    std::cout << "Use count: " << data.use_count() << "\n"; // 1
    return 0;
}
```

**è¦ç‚¹**ï¼š

- `shared_ptr` çš„å¼•ç”¨è®¡æ•°è‡ªåŠ¨ç®¡ç†èµ„æºã€‚
    
- å¯ä»¥å®‰å…¨åœ°è·¨å‡½æ•°ã€è·¨æ¨¡å—ä¼ é€’ã€‚
    

---

## ğŸ¯ æ¡ˆä¾‹ä¸‰ï¼šç”¨ `weak_ptr` é¿å…å¾ªç¯å¼•ç”¨

**åœºæ™¯**ï¼šä¸¤ä¸ªå¯¹è±¡äº’ç›¸æŒæœ‰æŒ‡é’ˆï¼Œå®¹æ˜“å½¢æˆå¾ªç¯å¼•ç”¨ã€‚

```cpp
#include <iostream>
#include <memory>

class B; // å‰å‘å£°æ˜

class A {
public:
    std::shared_ptr<B> b_ptr;
    ~A() { std::cout << "A destroyed\n"; }
};

class B {
public:
    std::weak_ptr<A> a_ptr; // ç”¨ weak_ptr ç ´åå¾ªç¯å¼•ç”¨
    ~B() { std::cout << "B destroyed\n"; }
};

int main() {
    auto a = std::make_shared<A>();
    auto b = std::make_shared<B>();
    a->b_ptr = b;
    b->a_ptr = a;

    // ä¸¤è€…ç¦»å¼€ä½œç”¨åŸŸæ—¶èƒ½æ­£ç¡®é‡Šæ”¾
    return 0;
}
```

**å¦‚æœç”¨ `shared_ptr` äº’ç›¸æŒæœ‰ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼**  
**ç”¨ `weak_ptr` æ‰“ç ´å¼ºå¼•ç”¨é“¾ï¼Œå¯ä»¥æ­£å¸¸é‡Šæ”¾ã€‚**

---

## ğŸ¯ æ¡ˆä¾‹å››ï¼šè‡ªå®šä¹‰åˆ é™¤å™¨ `shared_ptr` ç®¡ç†éå †å†…å­˜

**åœºæ™¯**ï¼šç®¡ç†èµ„æºï¼Œæ¯”å¦‚æ–‡ä»¶æè¿°ç¬¦ã€ç½‘ç»œè¿æ¥ç­‰ï¼Œä¸èƒ½ç›´æ¥ `delete`ã€‚

```cpp
#include <iostream>
#include <memory>
#include <cstdio> // Cæ–‡ä»¶æ“ä½œ

void customDeleter(FILE* fp) {
    if (fp) {
        std::cout << "Closing file\n";
        fclose(fp);
    }
}

int main() {
    std::shared_ptr<FILE> file(
        fopen("test.txt", "w"), customDeleter);

    if (file) {
        fputs("Hello, world!\n", file.get());
    }
    // æ–‡ä»¶ä¼šåœ¨ shared_ptr é”€æ¯æ—¶è‡ªåŠ¨å…³é—­
    return 0;
}
```

**è¦ç‚¹**ï¼š

- `shared_ptr` æ”¯æŒè‡ªå®šä¹‰åˆ é™¤å™¨ã€‚
    
- å¯ä»¥ç®¡ç†**é new åˆ†é…**çš„èµ„æºã€‚
    

---

## ğŸ¯ æ¡ˆä¾‹äº”ï¼šæ™ºèƒ½æŒ‡é’ˆæ­é…å®¹å™¨ä½¿ç”¨

**åœºæ™¯**ï¼šå­˜å‚¨ä¸€ç»„å¯¹è±¡ï¼Œè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸã€‚

```cpp
#include <iostream>
#include <vector>
#include <memory>

class Item {
public:
    Item(int id) : id(id) { std::cout << "Item " << id << " created\n"; }
    ~Item() { std::cout << "Item " << id << " destroyed\n"; }
    void show() const { std::cout << "Item ID: " << id << "\n"; }
private:
    int id;
};

int main() {
    std::vector<std::unique_ptr<Item>> items;
    items.push_back(std::make_unique<Item>(1));
    items.push_back(std::make_unique<Item>(2));
    items.push_back(std::make_unique<Item>(3));

    for (const auto& item : items) {
        item->show();
    }
    // ç¦»å¼€ä½œç”¨åŸŸï¼Œæ‰€æœ‰ Item è‡ªåŠ¨é”€æ¯
    return 0;
}
```

**è¦ç‚¹**ï¼š

- `unique_ptr` ä¸èƒ½æ‹·è´ï¼Œä½†å¯ä»¥**ç§»åŠ¨**ï¼Œå› æ­¤å¯ä»¥å­˜åˆ° `std::vector` ä¸­ã€‚
    
- é¿å…å¿˜è®°æ‰‹åŠ¨ `delete`ï¼Œç‰¹åˆ«é€‚åˆèµ„æºå¯†é›†å‹åº”ç”¨ã€‚
    

---

# ğŸ¯ æ€»ç»“ä¸€ä¸‹è¿™äº›æ¡ˆä¾‹çš„æ ¸å¿ƒå¥—è·¯ï¼š

|åœºæ™¯|é€‰æ‹©çš„æ™ºèƒ½æŒ‡é’ˆ|å¤‡æ³¨|
|:--|:--|:--|
|å•ç‹¬ç®¡ç†ä¸€ä¸ªå¯¹è±¡|`unique_ptr`|ç‹¬å èµ„æºï¼Œæ”¯æŒç§»åŠ¨|
|å¤šäººå…±äº«èµ„æº|`shared_ptr`|è‡ªåŠ¨å¼•ç”¨è®¡æ•°|
|è§‚å¯Ÿå…±äº«å¯¹è±¡ï¼Œä¸æŒæœ‰|`weak_ptr`|é˜²æ­¢å¾ªç¯å¼•ç”¨|
|ç®¡ç†éå †å†…å­˜èµ„æº|`shared_ptr + è‡ªå®šä¹‰åˆ é™¤å™¨`|å¦‚æ–‡ä»¶ã€socket|
|å®¹å™¨ä¸­ç®¡ç†å¯¹è±¡|`vector<unique_ptr<T>>`|å…ƒç´ å®‰å…¨é‡Šæ”¾|

---

